name: Run Selenium Tests with GitHub Runner Grid

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  selenium-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Start Selenium Grid
        run: |
          docker network create grid || true
          docker run -d -p 4442-4444:4442-4444 --net grid --name selenium-hub selenium/hub:4.25.0
          docker run -d --net grid -e SE_EVENT_BUS_HOST=selenium-hub \
            -e SE_EVENT_BUS_PUBLISH_PORT=4442 -e SE_EVENT_BUS_SUBSCRIBE_PORT=4443 \
            --shm-size="2g" selenium/node-chrome:4.25.0

          echo "Waiting for Selenium Grid to be ready..."
          # Get public IP (if VM has internet)
          PUBLIC_IP=$(curl -s ifconfig.me || echo "localhost")
          
          echo ""
          echo "âœ… Selenium Grid Hub is up and running!"
          echo "-----------------------------------------"
          echo "Hub Console URL:  http://$PUBLIC_IP:4444/ui"
          echo "Hub Endpoint:     http://$PUBLIC_IP:4444/wd/hub"
          echo "-----------------------------------------"
          echo ""
