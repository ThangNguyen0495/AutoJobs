name: 'IOS Appium Workflow Action'

on:
  push:
    branches: main
jobs:
  test_job:
    runs-on: macos-latest
    steps:
      - name: Get an available iOS simulator and boot it
        uses: ThangNguyen0495/create-ios-simulator@main
        
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 22
  
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
  
      - name: Install Appium
        run: npm install -g appium > /dev/null 2>&1
        
      - name: Cache Homebrew Packages
        id: cache-brew
        uses: actions/cache@v3
        with:
          path: |
            /usr/local/Cellar
            /opt/homebrew/Cellar
          key: brew-${{ runner.os }}-${{ hashFiles('**/Brewfile') }}
          restore-keys: |
            brew-${{ runner.os }}-

      - name: Install Homebrew (if missing)
        run: |
          if ! command -v brew &>/dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          else
            echo "Homebrew already installed."
          fi

      - name: Install FFmpeg and Carthage (if not cached)
        run: |
          if ! brew list ffmpeg &>/dev/null; then
            echo "Installing FFmpeg..."
            brew install ffmpeg
          else
            echo "FFmpeg is already installed."
          fi

          if ! brew list carthage &>/dev/null; then
            echo "Installing Carthage..."
            brew install carthage
          else
            echo "Carthage is already installed."
          fi
  
      - name: Install XCUITest driver
        run: appium driver install xcuitest > /dev/null 2>&1

      - name: Install WDA
        run: |
          cd ~/.appium/node_modules/appium-xcuitest-driver/node_modules/appium-webdriveragent
          nohup xcodebuild test-without-building \
            -project WebDriverAgent.xcodeproj \
            -derivedDataPath wda_build \
            -scheme WebDriverAgentRunner \
            -destination "platform=iOS Simulator,name=$DEVICE_NAME" \
            CODE_SIGNING_ALLOWED=NO > wda.log 2>&1 &

          cat wda.log
      - name: Check installed app
        run: |
          xcrun simctl listapps booted

      # - name: Start Appium server
      #   run: nohup appium -a 0.0.0.0 -p 4723 -pa /wd/hub --relaxed-security> appium_log.txt 2>&1 & > /dev/null 2>&1
      
